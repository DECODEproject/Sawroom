#!/usr/bin/env zsh

blend_name="sawroom"
blend_vers="1.0"

release="beowulf"
size="4096"

if [ -n "$armsdk_version" ]; then
	image_name="${blend_name}-${blend_vers}-${arch}-${device_name}-$(date '+%Y%m%d')"
elif [ -n "$vmsdk_version" ]; then
	image_name="${blend_name}-${blend_vers}-${arch}-$(date '+%Y%m%d')"
	image_name="${blend_name}-${blend_vers}-${arch}-virtual-$(date '+%Y%m%d')"
fi

blend_preinst() {
	fn blend_preinst
	req=()
	ckreq || return 1

	return
}

blend_postinst() {
	fn blend_postinst
	req=(strapdir)
	ckreq || return 1

	cat <<EOF | sudo tee ${strapdir}/blend-postinst
#!/bin/sh
#
# FROM not implemented
# Instruction: FROM dyne/devuan:beowulf
#
export debian=buster
export osarch=armhf
#
# LABEL not implemented
# Instruction: LABEL maintainer="Denis Roio <jaromil@dyne.org>"   homepage="https://sawroom.dyne.org"
#
export LC_ALL=C.UTF-8
export LANG=C.UTF-8
echo "deb http://pkgmaster.devuan.org/merged beowulf-security main" >> /etc/apt/sources.list
echo "deb http://pkgmaster.devuan.org/merged beowulf-updates  main" >> /etc/apt/sources.list
apt-get update -y -q && apt-get install -y -q     pkg-config     python3     python3-pip     python3-stdeb python3-dev     python3-protobuf     python3-cbor     python3-colorlog     python3-toml     python3-yaml     python3-zmq     python3-stem     protobuf-compiler     protobuf-compiler-grpc     libffi-dev     supervisor daemontools net-tools zsh curl unzip     && apt-get clean
pip3 install grpcio-tools wheel
curl https://sh.rustup.rs -sSf > /usr/bin/rustup-init  && chmod +x /usr/bin/rustup-init  && rustup-init -y
export PATH=\$PATH:/project/sawtooth-core/bin:/protoc3/bin:/project/sawtooth-core/bin:/root/.cargo/bin CARGO_INCREMENTAL=0
mkdir -p /etc/sawtooth/keys && mkdir -p /var/lib/sawtooth && mkdir -p /var/log/sawtooth
export PATH=\$PATH:/project/sawtooth-core/bin
mkdir -p /project && cd /project
wget https://github.com/hyperledger/sawtooth-sdk-python/archive/v1.2.2.tar.gz && tar xf v1.2.2.tar.gz && ln -s sawtooth-sdk-python-1.2.2 sawtooth-sdk-python     && /project/sawtooth-sdk-python/bin/protogen && pip3 install -e /project/sawtooth-sdk-python && rm -rf v1.2.2.tar.gz sawtooth-sdk-python-1.2.2 sawtooth-sdk-python
git clone https://github.com/DECODEproject/sawroom /project/sawroom && pip3 install -e /project/sawroom/src/petition-tp
wget https://sdk.dyne.org:4443/view/zenroom/job/zenroom-static-\$osarch/lastSuccessfulBuild/artifact/src/zenroom -O /usr/local/bin/zenroom && chmod +x /usr/local/bin/zenroom && git clone https://github.com/decodeproject/zenroom
apt-get install -y -q libssl-dev libzmq3-dev torsocks
wget https://github.com/hyperledger/sawtooth-core/archive/v1.3.0.tar.gz && tar xvf v1.3.0.tar.gz && ln -s sawtooth-core-1.3.0 sawtooth-core && cd /project/sawtooth-core && ./bin/protogen && cd /project/sawtooth-core/validator && cargo build
cd /project/sawtooth-core && pip3 install -e validator && cp validator/target/debug/sawtooth-validator /usr/local/bin && cp validator/target/debug/libsawtooth_validator.so /usr/local/lib && ldconfig
cd /project/sawtooth-core && pip3 install -e cli
cd /project/sawtooth-core && pip3 install -e rest_api
cd /project/sawtooth-core/families/settings/sawtooth_settings && cargo build && cp -v ./target/debug/settings-tp /usr/local/bin/settings-tp
cd /project/sawtooth-core/families/block_info/sawtooth_block_info && cargo build && cp -v ./target/debug/block-info-tp /usr/local/bin/block-info-tp
wget https://github.com/hyperledger/sawtooth-pbft/archive/v1.0.0.tar.gz && tar xfz v1.0.0.tar.gz && ln -s sawtooth-pbft-1.0.0 sawtooth-pbft     && ls -l && cd /project/sawtooth-pbft     && cargo build
cp /project/sawtooth-pbft/target/debug/pbft-engine /usr/local/bin
export DYNESDK=https://sdk.dyne.org:4443/job NETDATA_VERSION=1.10.0
wget -O tor.pub.asc https://raw.githubusercontent.com/DECODEproject/decode-os/master/docker-sdk/tor.pub.asc
apt-key add tor.pub.asc
echo "deb https://deb.torproject.org/torproject.org \$debian main" >> /etc/apt/sources.list
apt-get install -y -q golang redis-server redis-tools netdata tor nyx
useradd -ms /bin/zsh sawroom
export TORDAM_GIT=github.com/decodeproject/tor-dam
torpass="\$(echo "print(OCTET.random(16):url64())" | zenroom)" && go get -v -u \$TORDAM_GIT/... && cd ~/go/src/github.com/decodeproject/tor-dam && sed -i python/damhs.py -e "s/topkek/\$torpass/" && make install && make -C contrib install-init && torpasshash="\$(HOME=/var/lib/tor setuidgid debian-tor tor --quiet --hash-password "\$torpass")" && sed -e 's/User tor/User sawroom/' < \$HOME/go/src/\$TORDAM_GIT/contrib/torrc > /etc/tor/torrc && sed -e 's/HashedControlPassword .*//' -i /etc/tor/torrc && echo "HashedControlPassword \$torpasshash" >> /etc/tor/torrc && sed -e 's/Log notice .*/Log notice file \/var\/log\/tor\/tor.log/' -i /etc/tor/torrc
chmod -R go-rwx /etc/tor && chown -R sawroom /etc/tor && rm -rf /var/lib/tor/data && chown -R sawroom /var/lib/tor && mkdir -p /var/run/tor && chown -R sawroom /var/run/tor
cp /root/go/bin/dam* /usr/bin
mkdir -p /project && cd /project
pip3 install 'fastapi[all]' && pip3 install hypercorn
cat << __EOFF__ | base64 -d | bunzip2 > /etc/supervisor/supervisord.conf
QlpoOTFBWSZTWS7GsRUAACPfgEBQRPf//j//38q//9/gUAYbas8hnbcYgKlQVTDRNECG1TYp6j01PRHpGTQPUDQ0M1GmnppANTU2ip+CnqjTaIZPUMmmAQBkaaGDU8poCREI0ITVPaaU/QyJAPUABj1T1A09QAHGTJpphMjIGBGJowRhBo0wACCKQmiYE0BMk9CmgGgaBoAAAab6a/Is395J6nNObXyMLV9yynf7I/jnCeH8ysDjU7SQZCQgMIOA5H9BAfbXp4el1AWFAmgtlejjMB/Ayp2FGheCV98hsMAK4BlZQsngYFBKaMwEO4gj0amu1MvIy+K8nFO0556WGUynLKqBiL+gvCYSpTDyFIFHNF8Xp6iaEmhlff/e5264A4CNEp41kIqaBq7FANrgbn/IMOWTHCM7FuG7dHf6doipV+DieXEGjxgK+1nY2hNAc4Y3m9b2pY2ZRNWjWjxQMSJzthsnLSdkuN45ggpXuEepDxTTXlcTnrNBl81O4nS6/2K9QIrvmW+7ZbQtSyTfK4vSMJAmXpT3oI9Xd8ci1gU3e0eSSCT5rTNDRcaWDf10kaLvegZFUH0oqj9daDywojsRQnGhQwzrCDS1g1/LiE7GQSyTLlxQeiUsMoj1xlPHvxY3dogcMh+rX9zaBVI8PoPdR5EKoHgxfEjz6UVXay5zYVyLu48vh5+9Sz0bgRGdwtDjuOEYBkAi92k7Bs+08GjRIB/bWM19Uo1+Vt6YOtKcobJohtC0hgYdXNbS7URlLKwag1IJ6gTBGR2mFNmR1aRYQQqOBBbBZYaOWmQLRGC4fjQa7EZIwlSInKAyWBz1kZ9h3Yas1GJqWQxZdNL1gyrIdotPE6GJsTZDnx8qrMiZDYTMyV1sToR7EJ8I395YxJIgcELxAjgqQAPD+V0jib9ff9KX/in9BUCqNCE41RlFq/XaiZ/LopVJl4XYSDJy7w0QbstTQamAT+9LPRI1iuZp3j2MiIhiDHWlumaTTIM0pZAkE01PTRKyBZuRojdpPGssKJMYnnv27dJmZzDEM4HgBgiu799jdDAowHctc2YM9j6AW2jWO3IFT8v+r1ebgchDQurzL3tbU7OYaqAcCKdcc/6KD3pcnrLQZkJSAcJBnlSgUOs+Dbxc0jjxOMFnjAMdsVmYg0kFBd5rBkFuIUOkBUbQ2Ody+jNtzK80YpQKbw7C7o52SBvgOEIzYEPWkg3C7yOxpjLca3yTPqPKZIIIDy6EIFTYWpIji6XhpmF2myAiamqcVTRQmMpjuIqHJM9Z2zGLI4qHMaBYEkz1TsjmRQXLkB1gOnZ1EliBIIRl/myvj2R12Jlc60ZBmhM3pkURWNz3DYwoyEYuBuhFEYPPsSV8dvPGeyiYsJITdyDGeMVEqsD1w1IXIWLRr4BVskEigIuJUQo5ZAWZSiGiHAldIbF3MyiAYxtNjS9A6+3gik1r2JDtzCSYZKYp3g6WXQXayDBYOaRu7jkebnqRwxEq8K2HmlvL8Nz2VijTnkhSSzEe7o6sJA7oYIIg3QF480hWTSgO8Gc5yfEQ2VrbWqlqBeYkARfrGWty3ckhIjhEzKgpgnQXpqnbPlxi8HAwiEiE4CGlNsCE7B8ufhZry03wT706JU6YVv6id0bWUIWBonArGQu/j14dbzDknUXjelm4sJkgx0TAJYgylAxDTG6m2yenfwcq07dZu5cjyrqsU4IpIW2A5ihjJ2NQh1r0g1B4BcpTdmxBIJgNOG2sbsFlRS58egXZ9abB6CpBs1Y96Rmrs19LklGyMJuLoRgpbvgF2wQ24pkF3kHftSwQ0cOgT3pqLKKUiEINEp2qDangmOlu2ES4NqQLtc7UvxtzJXSALREqm4CQgcNMmD/F3JFOFCQLsaxFQA==
__EOFF__
cat << __EOFF__ | base64 -d | bunzip2 > /usr/local/bin/sawroom-validator
QlpoOTFBWSZTWdPuK8oAAEnfgAgw///+1zf2/c6////yQAI61ztw6bhKRNCninknoaNBPUepmoAA9R5TEGg0ANASiAp6EmntBNTPVTCeoABiDIA9QNAMQiJ6keo0GjRiNDQA0AaAGgaNNDTINBKgiYmmk9R6jamyajJoPUepgmjR6CMINDAg8DilgTd1t3WBIgqGwQEkYxwI9njqypGhWMkQFCkAAfOEDOpGWFJvp4vrR1C/FwsIPJXy3pCKVjujglLuia++R+8lEOtOT42VqZ3IZGwFTR09L+W9ltrOu3w8Fb07/x2/r5XdsiHiFp+ugGlJZnJ2VgYQB2duRLyBj6gGm8XfzzQ3bBifVXM7wT1IBSScAwhGLGCHe8+kBsCKiBuZcNsQoSe/EB/PgwHw4BA6A1fFnOPZkoBuJUszcprfoffazJT8gzepegyPQyHnYcdX5LM3y7gvH5oqfpQi4+D+ZBxc0HsQIKtNnsM2XL2nGMyUcseeMIGqYGchgCt4SLratqMkJqCmftyRws29Dxra5AQ0mIa7EG9ki8am3TpW+uBzRgW5IVPqwvbAkQaQkPUzK8bBDWEq6TemhePdm3FlckPtQYpbyby/jPAwQpnt6GdfBRgSJOwOEcOORmtQxLdd9VixnmmTNERM+XFbA33K16mosVEUvGlJ8WYdEitytBYoSiPokearjdOEWJQciwFSOIF0A/WQNUY/AmxuFCyFa+WwuK1YTYat5w1LhiDJqy7c2bL5yqGaurJimOkoOw9uip3YgSW9U5cTA9AdS5ljx5WKm64pieA36A2FxyJxSG0U4MMxOLkJdXeevUWhwYi/6rG9VaQWhVmXbA8MOIVSpNLWmFP4u5IpwoSGn3FeUA==
__EOFF__
cat << __EOFF__ | base64 -d | bunzip2 > /usr/local/bin/sawroom-start
QlpoOTFBWSZTWZSN5OAAABRfgAAwfAPgGgQgGAo/49+AIACEGqn5E0aaI0eieo03qnpPNUMRTamyjBGgNAADQhOxfba7ox2fmk/GuL7r5LSllckl3ePVrAM0NjTAk5Oer3VGMYk24P2AwI/kN7ZlkQ/dQf2uDQkf5rBZLC8brvNuIbMP4lVq7fU6KAeWq3pZMYRUgErGFqWphKxxDBQGRoIRFk/4u5IpwoSEpG8nAA==
__EOFF__
cat << __EOFF__ | base64 -d | bunzip2 > /usr/local/bin/sawroom-list
QlpoOTFBWSZTWclT9oUAAIHfgGAwf3/wGkAEAAo/79+/QAG9iKGMaGhoAMhoAAAAANCnqYTVN4mqPU0wQ0ZGGTRGTQxoaGgAyGgAAAAAkRIhgho1GJqZpAaZpNDGiASkExpsGhtjY0Nl2b2b+p5dCnhNcm5L1Vprkxfwwo6HhZILH217OdEQF3qQy0Ba/fFVC3biWmzaYyh/EWxh8keu5jQl+AhmWJrDpF11kkYOBN0mDr0hivdua+o8ESvuRwD/7txK0oS2nVMavMOWyu8Z3mYPFCsYvw2qKAzjTBpMd6a7hvzCGqYKcWrk0bZUbh+EavO8qRaPTavsVXtbO18jsHoFX90ZSeRYiBVrZHIatgxg9Ka1oI5r0ULnG1k8KuDKlRZtR55ZiObMgCTJg5chAUDxToHj8sL9FChOZi22Tg2cTf4mY2LsXHC+qthjcIsnFethcUi5eJDtpxTJMaG6T3L2E8XtXTjMtwFi3yIoUGYXfTNTFalwWiVrXUsh667rOv3yWCiaGGpNnDKi6LrGIqenmUz7HSFtz7/i2pYoL3ZBBZJBnIZAu5coqWk7YKwyaIZCWz8XckU4UJDJU/aF
__EOFF__
cat << __EOFF__ | base64 -d | bunzip2 > /usr/local/bin/sawroom-address
QlpoOTFBWSZTWU2HnVAAAE3fgAAwfefzHx/tiAr/79/+QAG6HOdtDSaRqDAjKek8g1Mj0xI9GjQA9JNAMkSPKjxT8qfqj2qfqnqeo00wQB6jaTIYhpoNT1AppiGgyAAAABoADQCSQjKhk08U2p5QbU0NAAeoaaAyAUAgmUlCScvvXc5Bbq1b4wv9AZH/BZJHFMdS1vnu4pgImFgWVzxSZhGCccQtq8VzrI853J4ebYscHhv9F/On0lflozQQNuuXk1kzpv/yoe9XGeOxprUPMzCgZmUgZCECzYZVUshJAKQiiUJKq7Y2efWnMfrW1pu0hJq93IQgn7XR2nBb9mJNoojmY1Q77QSntvL80Y+lbiJHRwKPq+DGjIBhiSTGJetcTK1GDhJd31WKdhtM2Zi/Ae6JzCsaGRt1+XsZVNAICvoZBmfANDumYVyCnUO/QqY79MnDvlYtS0TK8bFROLBQJLak4P9B4k9SNDA0TdyprTvE4oTmnbM5gtLDwDhVCnPEvegO+6ws3GQISikQ60EJ2rLPHbNUjriiIgrotl8EIgE1FIS4QyEkoAJLykJEU95xbQ0NBCjYo4xQKs8SW7AiIlWSVdEshTYPHbRawPdK5VODKqqWBSiHPC/kMj1ECusU/GGEY3qIQAcpCi1haywv2XXLDAVIrI9kZ6ddnJM+SNhgHuLbcr/7Jneawj/F3JFOFCQTYedUAA==
__EOFF__
cat << __EOFF__ | base64 -d | bunzip2 > /usr/local/bin/sawroom-seeds
QlpoOTFBWSZTWQ722/MAAEBfgAAwfGfwuiQwWI9/99/+MAGGqmISoBNJPU09oU0PRqaPU9I0eofqnp6ppkMGk0TUn5BlT9AnqmyIwmQaZGBM0Eqek0RT9RonqZNAYj1NHqABptQBIhJEaRMU3OindL3H0xctpy8zWStbnKJL8FZj7+v3U62RMPsy0OM4mSeS9owgyk7RlOboqjdCdtA6fjVVCw7t34Zdem426xDF8Roz6Qiv5sooY6u94bpPh63zNmyrnQrVpocOwXxx25GSiyODSyjLDFXwrWkvJitCr2L7DZwQq1fAjcKIt0LiNblhoT2DOR4tGR9WcaBgs+olGZG7+Zl6qIaH7GXnkJmFvSbxqODh8al0dUyHIh7fh011vfPSZ720cttEWBRlWZKQu7Jl0kYnN9bZw+1ioitu4fHKSJ/Oac81BFXM0yUGkwoMYY2g8kjjH3pF9OCYmDFDE8mRyJTZ1xi0WDnCiYYgtc5toECHnWaz3JsfOJCUruDNyDuvbO20jhlRJSIYNwfU81fiDrdIkpUbHOcFUhiQ5csq7rmFhEo1y0Y1IAagpqki8nI9UxhMRIFVrGJH+LuSKcKEgHe235g=
__EOFF__
cat << __EOFF__ | base64 -d | bunzip2 > /usr/local/bin/sawroom-genesis
QlpoOTFBWSZTWZ4F/MIAAERfgAAwfQPgAyqpGI7//9++QAHbdyC7uEpBNT1NDQbUMmgA0DIAASkKY00mIHqA9IAAA0AGJKeiAYgDRoNNAANA0Eioynqnp6Ao8piAABoGmnqBEiUj6YANwqKeEj5VYucpDXIsEUk9B4hhanlQ9vqPZyIFYSTqc1kOFHixWoFMxsJBdILh+GkVI13F1c0tiYE3uGi1M2GAQGjVWLSSIECFJRtB5Da5oqIgdTtrqHx0ikWMjtFxMg4w6uda2byapYi63tcVRNEpx9JMB8XAJkoIFB1aUAY9aWcSgFKQN5MCozDddag25EAkLKzAZNRN9KqKzsz9CKvUTvAoFViZKwCAQ0rI5IokFwXqW8ZaHhN4MG2gbClGYSqzKC1LgENKuZpnjMGFA1+DJ36w6QyOM0GsiY3J0FJAiBSECnAvgKBETSsKLziv0BgSGIrDFIbWoHy1qSRYcpeGecqhSMIn3XJNKSWUtomhwLJ0YC4DVJ9lScsAYhDAXQSR9wgwyNQkkmF44gYgKrQiAFx5JaVQydFsR4t4FtUSILByIMR7Y0lL6SiUPmmKSRpqkDNFdzSCOAfQzFf4u5IpwoSE8C/mEA==
__EOFF__
chmod 775 /usr/local/bin/sawroom-*
echo "127.0.0.1 validator" >> /etc/hosts && echo "127.0.0.1 rest-api" >> /etc/hosts
#
# CMD not implemented
# Instruction: CMD /etc/init.d/supervisor start
#

EOF

	chroot-script -d blend-postinst || zerr

	return
}
