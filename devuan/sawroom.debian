#!/bin/sh
#
# FROM not implemented
# Instruction: FROM dyne/devuan:beowulf
#
export debian=buster
#
# LABEL not implemented
# Instruction: LABEL maintainer="Denis Roio <jaromil@dyne.org>"   homepage="https://sawroom.dyne.org"
#
export LC_ALL=C.UTF-8
export LANG=C.UTF-8
apt-get update -y -q && apt-get install -y -q     g++     pkg-config     python3     python3-pip     python3-stdeb python3-dev     python3-protobuf     python3-cbor     python3-colorlog     python3-toml     python3-yaml     python3-zmq     python3-grpcio     python3-grpc-tools     supervisor daemontools net-tools zsh curl unzip     && apt-get clean
pip3 install wheel
curl https://sh.rustup.rs -sSf > /usr/bin/rustup-init  && chmod +x /usr/bin/rustup-init  && rustup-init -y
export PATH=$PATH:/project/sawtooth-core/bin:/protoc3/bin:/project/sawtooth-core/bin:/root/.cargo/bin CARGO_INCREMENTAL=0
mkdir -p /etc/sawtooth/keys && mkdir -p /var/lib/sawtooth && mkdir -p /var/log/sawtooth
export PATH=$PATH:/project/sawtooth-core/bin
mkdir -p /project && cd /project
curl -OLsS https://github.com/google/protobuf/releases/download/v3.5.1/protoc-3.5.1-linux-x86_64.zip && unzip protoc-3.5.1-linux-x86_64.zip -d protoc3 && cp -v protoc3/bin/protoc /usr/local/bin && rm -rf protoc-3.5.1-linux-x86_64.zip protoc3
wget https://github.com/hyperledger/sawtooth-sdk-python/archive/v1.2.3.tar.gz && tar xf v1.2.3.tar.gz && ln -s sawtooth-sdk-python-1.2.3 sawtooth-sdk-python     && /project/sawtooth-sdk-python/bin/protogen && pip3 install -e /project/sawtooth-sdk-python && rm -rf v1.2.3.tar.gz sawtooth-sdk-python-1.2.3 sawtooth-sdk-python
git clone https://github.com/DECODEproject/petition-tp-python /project/petition-tp-python && pip3 install -e /project/petition-tp-python/src
wget https://files.dyne.org/zenroom/nightly/zenroom-linux-amd64 -O /usr/local/bin/zenroom && chmod +x /usr/local/bin/zenroom
export PATH=$PATH:/project/petition-tp-python/bin
apt-get install -y -q libssl-dev libzmq3-dev torsocks
wget https://github.com/hyperledger/sawtooth-core/archive/v1.2.5.tar.gz && tar xvf v1.2.5.tar.gz && ln -s sawtooth-core-1.2.5 sawtooth-core && cd /project/sawtooth-core && ./bin/protogen && cd /project/sawtooth-core/validator && cargo build
cd /project/sawtooth-core && pip3 install -e validator && cp validator/target/debug/sawtooth-validator /usr/local/bin && cp validator/target/debug/libsawtooth_validator.so /usr/local/lib && ldconfig
cd /project/sawtooth-core && pip3 install -e cli
cd /project/sawtooth-core && pip3 install -e rest_api
cd /project/sawtooth-core/families/settings/sawtooth_settings && cargo build && cp -v ./target/debug/settings-tp /usr/local/bin/settings-tp
cd /project/sawtooth-core/families/block_info/sawtooth_block_info && cargo build && cp -v ./target/debug/block-info-tp /usr/local/bin/block-info-tp
git clone https://github.com/hyperledger/sawtooth-devmode.git sawtooth-devmode && cd /project/sawtooth-devmode && cargo build
cp /project/sawtooth-devmode/target/debug/devmode-engine-rust /usr/local/bin
wget https://github.com/hyperledger/sawtooth-pbft/archive/v1.0.3.tar.gz && tar xfz v1.0.3.tar.gz && ln -s sawtooth-pbft-1.0.3 sawtooth-pbft     && ls -l && cd /project/sawtooth-pbft     && cargo build
cp /project/sawtooth-pbft/target/debug/pbft-engine /usr/local/bin
export DYNESDK=https://sdk.dyne.org:4443/job NETDATA_VERSION=1.10.0 STEM_VERSION=1.6.0 STEM_GIT=https://git.torproject.org/stem.git
wget -O tor.pub.asc https://raw.githubusercontent.com/DECODEproject/decode-os/master/docker-sdk/tor.pub.asc
apt-key add tor.pub.asc
echo "deb https://deb.torproject.org/torproject.org buster main" >> /etc/apt/sources.list
apt-get install -y -q golang redis-server redis-tools netdata tor nyx
useradd -ms /bin/zsh sawroom
export TORDAM_GIT=github.com/decodeproject/tor-dam
torpass="$(echo "print(OCTET.random(16):url64())" | zenroom)" && go get -v -u $TORDAM_GIT/... && cd ~/go/src/github.com/decodeproject/tor-dam && sed -i python/damhs.py -e "s/topkek/$torpass/" && make install && make -C contrib install-init && torpasshash="$(HOME=/var/lib/tor setuidgid debian-tor tor --quiet --hash-password "$torpass")" && sed -e 's/User tor/User sawroom/' < $HOME/go/src/$TORDAM_GIT/contrib/torrc > /etc/tor/torrc && sed -e 's/HashedControlPassword .*//' -i /etc/tor/torrc && echo "HashedControlPassword $torpasshash" >> /etc/tor/torrc && sed -e 's/Log notice .*/Log notice file /var/log/tor/tor.log/' -i /etc/tor/torrc
chmod -R go-rwx /etc/tor && chown -R sawroom /etc/tor && rm -rf /var/lib/tor/data && chown -R sawroom /var/lib/tor && mkdir -p /var/run/tor && chown -R sawroom /var/run/tor
cp /root/go/bin/dam* /usr/bin
mkdir -p /project && cd /project
pip3 install 'fastapi[all]' && pip3 install hypercorn
cat << __EOFF__ | base64 -d | bunzip2 > /etc/supervisor/supervisord.conf
QlpoOTFBWSZTWW8R2OIAACPfgEBQRPf//j//38q//9/gUAYKr3RLO2jqgEQFU4aJpqaFG2qYT0mJtIyaeoNHqBoMmI9TT0IBojRPRNT1Q9T0TTRpo0ABiADIB6mQBIiTUwTKnqManqHiT1AAAAaAAAOMmTTTCZGQMCMTRgjCDRpgAEEigmgAIBGjVAYgNNDRoA0Mg0lbJnEBnTnaPU2rmMshgQLigJLdLKszCN2xCcJlHGEA5zIgpiIF2nAYFUKW6WCOcPDgb4Bnvb+qkAfQtrfPO9t2WKIhrMAMtidb7ShBgXyY8dIEm4gkNlj3ULWRa4ts07IJZZoVDvui89QDkP+k/jQNc5U5jYHJfnTOlu2cAhoZV4v3vdgrOAcCNqYUIWMN8ae1gD9UT8v5HNPaxSDKrajbaHj6dBEyb7OEfDqDR5oBPW6o0CMgcaV2EbLLq0rnfBNjRkjuIGJE4V0ZzfjOcuOQcwQU8leoj0oOyM9eNhGOsUChXLkRlX70+gDnAn5JVyKkTgsIULEO2AIv86PKx+nl9ECiYkafEdkQCC76FyGiwaVG/RKI0WPegZCaDzomj14oPxpJGxFCbaFDRhZCDGtQy79oTmyCWSX7eog5ZS0XxHri+dvC1jdzRA4ZD9WXobQKwjl8R1kcxCmB2YvKj+NkTXcyw9TCdpY7B2+T1fDKp3twEQuiDUONSssAYQCOXdoOoa/tPF49rQH9sVackop89ta4HPK8UlV2wNgakkanRj24XUEZSyqNIekd6gEoske0wx9xKEaLhGLUQYeovKhXdDA8pyfL7gEfcmycq2iaVgLXfKPEhd0O+mFyhWYK0YrdpWTgWziHcK/zGbE2IzIdHNjZVOnOaks6atSp1JDgF6YcPA0YEtIIBJCQI46EAPD2JZPebaebzot/RHtCoCpCkNG+pCg6JffRCMfb6M0iiJFwWXwDFY94ZgKvHUzFUXBH80T+WBq6sTLvF4GA202X6SpliiKMAxRKbEMlGl44pVQLByNEceM7rJYUSYxPDXq1YzMzgFYXQHQCiJ7vZk3IoSYDsKrDKjPW8wWkmrdV4KnxpxfVwP/IhoXH9i66tdLq5hqwA2EU1x+HUkLuRWj3FAURokwV0A8csZzCZ3R3qvgskPhwODJ4ME+t6US8FKASEtjRmAUvCRzYVCoG+1ZWJfJkq8irihOUgluDqJbPlOAK1hvaFFNIPciAbCW4Z1Mr4bGlsEY6i4RIAxh25jQFRYURAe9ZWhliFeVjBxSNEb0kZJBEUIi1HUHBGOkaRE58IcEgz4iqCgQRnqjqhZjkJZcQOjB4dVqIheBBNCh/llPHqha2IwsOSLQuQmcUyEkT3xG942MJMgitwN0IohM4XIi97eDyuojFNECOfyBjOLqIqkxdPDUQtwrWjLYFjZKEigIuQqIUbi8CrKUQ0Q4QrkhsW1l8QDGNpsaXVHPlREozn4EBZ4hBF2CRejuBZV1FekEXJM4oevI4HfxwRzrEp851DuS4FnPc8pwk04+KFEiyse7PfQiByaYxs1YWi4oaSgpSBbAoxjBeIgsqqpVUkUQFpeMB26PDStKvghob3YQkQkJFyOaFz0R1x4b3aCuLm0No3CDKWbEEZi7cfCenDLZke5HNFRzuqt6COTzINBMMkbip4CW2/pu6Wl3BHQS32ou1JkSARyRcELwUIMTapjhTnWTjv2OVWdWRxbtxzWaalNiKSFcwcxQtk6NQQ5z2BVAtwVpEtcU2QCICluzqetyUKJFq3mwLcNabB4ipBnpt3pGCuZl0HJKM40TYLNFCLH0vCuwQaYIxCvsFeaJiDFZ8wjsjQSg5SbQMyRLrUCojwRflTNoRlYGaGETCnQQislmGSABeFTMMgTSBrhrvD/F3JFOFCQbxHY4g
__EOFF__
cat << __EOFF__ | base64 -d | bunzip2 > /usr/local/bin/sawroom-validator
QlpoOTFBWSZTWdPuK8oAAEnfgAgw///+1zf2/c6////yQAI61ztw6bhKRNCninknoaNBPUepmoAA9R5TEGg0ANASiAp6EmntBNTPVTCeoABiDIA9QNAMQiJ6keo0GjRiNDQA0AaAGgaNNDTINBKgiYmmk9R6jamyajJoPUepgmjR6CMINDAg8DilgTd1t3WBIgqGwQEkYxwI9njqypGhWMkQFCkAAfOEDOpGWFJvp4vrR1C/FwsIPJXy3pCKVjujglLuia++R+8lEOtOT42VqZ3IZGwFTR09L+W9ltrOu3w8Fb07/x2/r5XdsiHiFp+ugGlJZnJ2VgYQB2duRLyBj6gGm8XfzzQ3bBifVXM7wT1IBSScAwhGLGCHe8+kBsCKiBuZcNsQoSe/EB/PgwHw4BA6A1fFnOPZkoBuJUszcprfoffazJT8gzepegyPQyHnYcdX5LM3y7gvH5oqfpQi4+D+ZBxc0HsQIKtNnsM2XL2nGMyUcseeMIGqYGchgCt4SLratqMkJqCmftyRws29Dxra5AQ0mIa7EG9ki8am3TpW+uBzRgW5IVPqwvbAkQaQkPUzK8bBDWEq6TemhePdm3FlckPtQYpbyby/jPAwQpnt6GdfBRgSJOwOEcOORmtQxLdd9VixnmmTNERM+XFbA33K16mosVEUvGlJ8WYdEitytBYoSiPokearjdOEWJQciwFSOIF0A/WQNUY/AmxuFCyFa+WwuK1YTYat5w1LhiDJqy7c2bL5yqGaurJimOkoOw9uip3YgSW9U5cTA9AdS5ljx5WKm64pieA36A2FxyJxSG0U4MMxOLkJdXeevUWhwYi/6rG9VaQWhVmXbA8MOIVSpNLWmFP4u5IpwoSGn3FeUA==
__EOFF__
cat << __EOFF__ | base64 -d | bunzip2 > /usr/local/bin/sawroom-start
QlpoOTFBWSZTWZSN5OAAABRfgAAwfAPgGgQgGAo/49+AIACEGqn5E0aaI0eieo03qnpPNUMRTamyjBGgNAADQhOxfba7ox2fmk/GuL7r5LSllckl3ePVrAM0NjTAk5Oer3VGMYk24P2AwI/kN7ZlkQ/dQf2uDQkf5rBZLC8brvNuIbMP4lVq7fU6KAeWq3pZMYRUgErGFqWphKxxDBQGRoIRFk/4u5IpwoSEpG8nAA==
__EOFF__
cat << __EOFF__ | base64 -d | bunzip2 > /usr/local/bin/sawroom-list
QlpoOTFBWSZTWclT9oUAAIHfgGAwf3/wGkAEAAo/79+/QAG9iKGMaGhoAMhoAAAAANCnqYTVN4mqPU0wQ0ZGGTRGTQxoaGgAyGgAAAAAkRIhgho1GJqZpAaZpNDGiASkExpsGhtjY0Nl2b2b+p5dCnhNcm5L1Vprkxfwwo6HhZILH217OdEQF3qQy0Ba/fFVC3biWmzaYyh/EWxh8keu5jQl+AhmWJrDpF11kkYOBN0mDr0hivdua+o8ESvuRwD/7txK0oS2nVMavMOWyu8Z3mYPFCsYvw2qKAzjTBpMd6a7hvzCGqYKcWrk0bZUbh+EavO8qRaPTavsVXtbO18jsHoFX90ZSeRYiBVrZHIatgxg9Ka1oI5r0ULnG1k8KuDKlRZtR55ZiObMgCTJg5chAUDxToHj8sL9FChOZi22Tg2cTf4mY2LsXHC+qthjcIsnFethcUi5eJDtpxTJMaG6T3L2E8XtXTjMtwFi3yIoUGYXfTNTFalwWiVrXUsh667rOv3yWCiaGGpNnDKi6LrGIqenmUz7HSFtz7/i2pYoL3ZBBZJBnIZAu5coqWk7YKwyaIZCWz8XckU4UJDJU/aF
__EOFF__
cat << __EOFF__ | base64 -d | bunzip2 > /usr/local/bin/sawroom-address
QlpoOTFBWSZTWaob6twAAFBfgAAwfefRHx/tiAr/79/+QAHaHOdtcNEU9Ke1PU9U9I/RGpmmUNP1TamPUTGkHppNGgyiBPUZpPQhoDQADQAAADTUTSPRNAaANAAAGgANGgkkNRqTaI8p5T1DT1AAAABpkAUBBMxSKJzfNl3mHHnFq4Rhq5aJkc8lkkc5tZ2D14mtdBjONw5F2c9CEA+94sHJiyXH9ZJGi0pB0ux0TYObf4eSMUWGqulzmNwLfe2FEm/1idbCzRPuYzSOinqQhCCpCgZjftQVcDUEkBEZ11BJQjZ4wFG2l/nWG3487ZQZYcl0geC+xw2JnO4TeDXqEs2rhcCct3xlgw595R/LAgVdwDXJK9LaNNorcz0FWBPrPm0VDDaH4mOGo9kUGRXIZFuHfgYJ5BIUOythHASHDz5XFvILNJD9NDK1j0i04fC1dK3unUFsdFoPieu2pD4PyNgrrQxpUiqIbzpcnM/4LFNFiBTbw9F0qFFMMEUpuRMQD923DCr2bJIQuERPoFl+g0Hp1vGfKhJIuJfLHwoJQECVAyEMEJJCAkF9aKBq6xjk444xFr1lptE5ZmmYtqRSkYi4mrqd0svIiYyUodmMSSWRiOtMlIECw1zD0lsgSyiCnMiSRxykwMDLBk0YxipqOQhuKqQmrSzU9VL16jQAjNCjjL76k9aLEhYIf4u5IpwoSFUN9W4A
__EOFF__
cat << __EOFF__ | base64 -d | bunzip2 > /usr/local/bin/sawroom-seeds
QlpoOTFBWSZTWQ722/MAAEBfgAAwfGfwuiQwWI9/99/+MAGGqmISoBNJPU09oU0PRqaPU9I0eofqnp6ppkMGk0TUn5BlT9AnqmyIwmQaZGBM0Eqek0RT9RonqZNAYj1NHqABptQBIhJEaRMU3OindL3H0xctpy8zWStbnKJL8FZj7+v3U62RMPsy0OM4mSeS9owgyk7RlOboqjdCdtA6fjVVCw7t34Zdem426xDF8Roz6Qiv5sooY6u94bpPh63zNmyrnQrVpocOwXxx25GSiyODSyjLDFXwrWkvJitCr2L7DZwQq1fAjcKIt0LiNblhoT2DOR4tGR9WcaBgs+olGZG7+Zl6qIaH7GXnkJmFvSbxqODh8al0dUyHIh7fh011vfPSZ720cttEWBRlWZKQu7Jl0kYnN9bZw+1ioitu4fHKSJ/Oac81BFXM0yUGkwoMYY2g8kjjH3pF9OCYmDFDE8mRyJTZ1xi0WDnCiYYgtc5toECHnWaz3JsfOJCUruDNyDuvbO20jhlRJSIYNwfU81fiDrdIkpUbHOcFUhiQ5csq7rmFhEo1y0Y1IAagpqki8nI9UxhMRIFVrGJH+LuSKcKEgHe235g=
__EOFF__
cat << __EOFF__ | base64 -d | bunzip2 > /usr/local/bin/genesis-create
QlpoOTFBWSZTWclBIPAAAF5fgAAwfWf3Gw6p3A6//9/+QAJ7bpd27tzKEqaBU9PQp+gpk02oD1A0DRoG01PSGmgkoTTT1NTKeiZlGjQAAAAADQSJRlCHpqeRPU0ABoAABoGhoJFCU8TUyabU2oaDTymgANDEAAYLKj9U16vvNCgiY2vihR8wRm8KXObPHYVSMKJAehZVU/4auTu33qr+m75HGSBqnYTaG5G39+dXk9rRr3ZceDIoOmnobgkKRuQGVpDP4TQxW7jGTQIxsl7LM13B06EyIgNWhmgBzMkOnMbUTDGwijbZxFYSGjhnFE3ho0awXcEhyTvaI4sMDZ3aiSGgRXUw/GafW+rShahLVWMzkDixXXst9i3Xrwe4U76e0laudijUIxeXmoD8n3gyouMZce8ii4B9qpsaTaDxKgKS0PbjwIMenmuIJhgFEm+W1tZypkiFeHRO/JKekYbayYeDr4r8oGSglSc4GmArq7sB6tAiEbFgY87E4RywrjGoJEwSVPyM2Q7L7xsbG2IYxa0kq9cVgsl2vkW1T1BmaZSQWBucorQ+KaCO1KeOo/mQFA0aBmOypqwNs3CZvEjIWqIZQMpHIBhII2GKM0woEBMRfIVYizDbQFZVeIFDEYA10hzPW2DmtVaRErwc26ZCFOjS4cOVBQ08cg2cxkGDFNZbkHCwPM6soUIqLhilP/oK81HRCCGXUDTvVWAzJHM224LI4HjgtvGfELEGWusxARBIsYrHcwHKeyyMSihUkWAX3LA20FmrIJWJElhPFNShAzKZSwp5cCIxmGmS1qh7i58CrDSxBOpzRqr8ILlKqv/F3JFOFCQyUEg8AA==
__EOFF__
cat << __EOFF__ | base64 -d | bunzip2 > /usr/local/bin/genesis-import
QlpoOTFBWSZTWZsa4VgAABNfgCAQaIKVEj6v3oE/79/UIACVDGgZAAAABoZAABE0IyNT00Q8oDQAaNPUPUbU9ScnURL7OAfbqIVQqbvG3YlsgvvLU42ZFhMjnEEQJuuMBG8AylnindHXIyRdoYXAWjmCO9BaoJglAsCIiRUojhAKWs/q3X39TdhDV00v4JekyrVz+YMkahldcacInmsWJ8IqOtWJH5iGvLKk50gH8XckU4UJCbGuFYA=
__EOFF__
cat << __EOFF__ | base64 -d | bunzip2 > /usr/local/bin/genesis-export
QlpoOTFBWSZTWQi2OZkAABhfgCAwfAOVIz6v2oQ/5d+UMACmwSqNqg9TTTTQxGmajTID1D1DIA0p6p+ieqfqI9QAAAABkepkEqgTBMjRgjAjQaMGoMCwQKwaLSJSnA2Pzh3k5UUbosA78fKNMhMZ5noAR8CwlEPFw/JmKrVJlcyu7HZbHAxhK4WNOxs4Pa+i7TYMltws4eBkNo4wkwKmA0IFxQXECBUMZpg2xdQVJ51LQAhS5AOAsbxGJicIys8i80CFbwi1NAfQh/AJhO59TSGFOayGvIS13VklN0MAp/i7kinChIBFsczI
__EOFF__
cat << __EOFF__ | base64 -d | bunzip2 > /usr/local/bin/keys-create
QlpoOTFBWSZTWdskLQEAAAzfgAAQbAOAAgZCiAo+79+0IACKhqaFG00NpI/UjI2o09TynqDRExGgAGhoNAONZBiuGrWPiC36vSbWbA3oYuBEQT1DAuUbs2ykm/PZDcRTpU96lOBi8LGnrtyMHqUM9mRp3VwI2QES8z5Js8XfVbuGUHiEjoxUxEgy/FS3msgUHX1CNzPtG1o0KaeViTsWgISSyb8DH4u5IpwoSG2SFoCA
__EOFF__
cat << __EOFF__ | base64 -d | bunzip2 > /usr/local/bin/keys-export
QlpoOTFBWSZTWY6hd04AADdfgCAwfQOVIj7vnKo/b9++MAEZTUJU1CGjQ0eo0yGTQNAGhiBpkGUapm0iNAAaaAAAANABVU9QhkhtTQ0ZBkAyGI8kyMTSkTJDJgqUlaTeho4KFmzStkbIjOrYkzQ5TL5xHNmiN+7gdU16WdjeKz77+4yGKC4hSIQA6BoBk7CEKkJHCBSIY/nDU15Xuhs/TkOCyxdUhgVFh740YaGhcYT5alas4y4VrFxqKCovayKrqdrSrqk+FtpWmWTMeG5NkRJPJXv20PVgWUYQDjGgNnc4KdTzGJwCrXD2dYSFgaAX/AK3BnkXl1/Cri5OUklvoJdtpC+pc8kSpVKcvyvI7UUCyWSsQkhKRfkL4yykLrbAYhgea4gJlH8XckU4UJCOoXdO
__EOFF__
echo "127.0.0.1 validator" >> /etc/hosts && echo "127.0.0.1 rest-api" >> /etc/hosts
#
# CMD not implemented
# Instruction: CMD /etc/init.d/supervisor start
#

